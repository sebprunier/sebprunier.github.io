---
layout: post
title: Bonita Open Solution - charger une Combobox avec le résultat d'un appel WebService
date: 2011-06-16 15:35:33.000000000 +02:00
categories:
- Tutoriels
tags:
- Bonita
- BPM
- SOAP
- WebService
status: publish
type: post
published: true
meta:
  _edit_last: '24226490'
author: 
---
<h2>L'objectif du tutoriel</h2>
<p>Ce tutoriel illustre pas-à-pas une manière possible d'alimenter dynamiquement le contenu d'une liste déroulante (combobox proposant la liste des pays).</p>
<p><a href="http://sebprunier.files.wordpress.com/2011/06/bonita-objectif.png"><img class="aligncenter size-medium wp-image-25" title="bonita-objectif" src="assets/bonita-objectif.png?w=300" alt="" width="300" height="153" /></a></p>
<p>La démo a été réalisée avec la version 5.4.2 de Bonita Open Solution et permet d'illustrer :</p>
<ul>
<li>l'utilisation du connecteur WebService de Bonita,</li>
<li>l'alimentation dynamique d'une combobox, dans un pageflow de saisie.</li>
</ul>
<p><!--more--></p>
<h2>Le WebService d'alimentation</h2>
<p>Les valeurs de la combo sont issues du résultat d'un appel à un WebService fournissant la liste des pays : <a href="http://www.webservicex.net/country.asmx?WSDL">www.webservicex.net</a></p>
<p>L'appel au service "GetCountries" retourne la réponse SOAP suivante, que nous devrons ensuite traiter au niveau du connecteur WebService Bonita :</p>
<pre>&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
  &lt;soap:Body&gt;
    &lt;GetCountriesResponse xmlns="http://www.webserviceX.NET"&gt;
      &lt;GetCountriesResult&gt;
        <span style="color:#800080;"><strong>&lt;![CDATA[</strong> &lt;NewDataSet&gt; &lt;Table&gt; &lt;Name&gt;Afghanistan, Islamic State of&lt;/Name&gt; &lt;/Table&gt; &lt;Table&gt; &lt;Name&gt;Albania&lt;/Name&gt; &lt;/Table&gt; ... &lt;Table&gt; &lt;Name&gt;Zimbabwe&lt;/Name&gt; &lt;/Table&gt; &lt;/NewDataSet&gt; <strong>]]&gt;</strong></span>
      &lt;/GetCountriesResult&gt;
    &lt;/GetCountriesResponse&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</pre>
<p><em>Remarque : le contenu de la réponse SOAP, donc la liste des pays, est au format XML (section CDATA).</em></p>
<h2>Le processus de la démo</h2>
<p>Le processus mis en oeuvre pour les besoins de la démo n'a - soyons clair - aucun intérêt fonctionnel ! :-) Il définit simplement deux activités permettant respectivement de :</p>
<ul>
<li>choisir un pays (ici intervient la liste déroulante dans le pageflow)</li>
<li>afficher le pays choisi</li>
</ul>
<p><a href="http://sebprunier.files.wordpress.com/2011/06/bonita-process.png"><img class="aligncenter size-full wp-image-36" title="bonita-process" src="assets/bonita-process.png" alt="" width="630" height="154" /></a></p>
<p>Deux variables sont rattachées au processus :</p>
<ul>
<li><strong>listePays</strong> : une variable "Objet Java" de type java.util.List, qui permet de stocker la liste des pays et qui servira à alimenter les valeurs de la combobox,</li>
<li><strong>paysChoisi</strong> : une variable de type "Texte" pour stocker le pays sélectionné dans la combobox.</li>
</ul>
<p><a href="http://sebprunier.files.wordpress.com/2011/06/bonita-variable-liste.png"><img class="aligncenter size-medium wp-image-37" title="bonita-variable-liste" src="assets/bonita-variable-liste.png?w=300" alt="" width="300" height="217" /></a></p>
<h2>La configuration du connecteur WebService</h2>
<h3>Sélection du connecteur</h3>
<p>Le connecteur utilisé est "Client Web Service", dans la catégorie "Web Services".</p>
<p><a href="http://sebprunier.files.wordpress.com/2011/06/bonita-connecteurws.png"><img class="aligncenter size-medium wp-image-40" title="bonita-connecteurws" src="assets/bonita-connecteurws.png?w=300" alt="" width="300" height="200" /></a></p>
<p>J'ai choisi d'ajouter le connecteur au niveau de l'activité "Choisir un pays". J'aurais pu tout aussi bien l'ajouter directement au niveau du processus. A vous de choisir en fonction de vos besoins.</p>
<p>Le connecteur est activé dès l'entrée dans l'activité, afin que la liste des pays soit disponible pour le pageflow de saisie :</p>
<p><a href="http://sebprunier.files.wordpress.com/2011/06/bonita-connecteurws-1.png"><img class="aligncenter size-medium wp-image-41" title="bonita-connecteurws-1" src="assets/bonita-connecteurws-1.png?w=300" alt="" width="300" height="274" /></a></p>
<h3>Configuration de l'appel WebService</h3>
<p>La configuration de l'appel au webservice est basique. N'hésitez pas à utiliser un outil comme <a href="http://www.soapui.org/" target="_blank">soapUI</a> pour vous aider à créer la requête SOAP :</p>
<pre>&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                  xmlns:web="http://www.webserviceX.NET"&gt;
   &lt;soapenv:Header/&gt;
   &lt;soapenv:Body&gt;
      &lt;web:GetCountries/&gt;
   &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</pre>
<p><a href="http://sebprunier.files.wordpress.com/2011/06/bonita-connecteurws-2.png"><img class="aligncenter size-medium wp-image-44" title="bonita-connecteurws-2" src="assets/bonita-connecteurws-2.png?w=300" alt="" width="300" height="258" /></a></p>
<h3>Traitement du résultat</h3>
<p>Il reste maintenant à traiter le résultat de l'appel, c'est à dire la réponse SOAP. L'objectif est de créer une liste de valeurs à partir de l'objet <strong>"response"</strong> (javax.xml.transform.dom.DOMSource), et d'affecter cette liste à la variable <strong>"listePays"</strong>.</p>
<p>La création de la liste de valeurs à partir de la réponse est l'étape sûrement la plus complexe. Il est nécessaire d'éditer une expression à l'aide de l'éditeur groovy, afin d'écrire le traitement. N'étant pas spécialiste groovy, je vous présente <span style="text-decoration:underline;">une</span> façon de faire, rapide et pas forcément très "safe" :</p>
<pre>// Récupération du contenu (liste des pays en XML)
Element root = ((DOMSource) response).getNode().getFirstChild();
NodeList result = root.getElementsByTagName("GetCountriesResult");
String xmlContent = result.item(0).getTextContent();

// Récuparation de la liste des pays (avec XPath)
DocumentBuilder builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();
Document doc = builder.parse(new ByteArrayInputStream(xmlContent.getBytes()));
String expression = "//Name";
XPath xpath = XPathFactory.newInstance().newXPath();
NodeList nodes = (NodeList) xpath.evaluate(expression, doc, XPathConstants.NODESET);

// Alimentation de la liste (résultat en sortie)
List&lt;String&gt; names = new ArrayList&lt;String&gt;();
for (int i = 0; i &lt; nodes.getLength(); i++) {
    names.add(nodes.item(i).getTextContent());
}
return names;</pre>
<p><em>(ah, ce bon vieux java comme dirait l'autre ... :-))</em></p>
<p>L'affectation du résultat du traitement dans la variable "listePays" se fait graphiquement :</p>
<p><a href="http://sebprunier.files.wordpress.com/2011/06/bonita-connecteurws-3.png"><img class="aligncenter size-medium wp-image-45" title="bonita-connecteurws-3" src="assets/bonita-connecteurws-3.png?w=300" alt="" width="300" height="152" /></a></p>
<p>A ce stade, la configuration du connecteur est terminée ! Passons à l'étape de création du pageflow.</p>
<h2>L'alimentation de la combobox</h2>
<p>Maintenant le reste, c'est du gâteau !</p>
<p>Au niveau du pageflow de saisie de l'activité "Choisir un pays", il suffit simplement d'alimenter la combobox avec la variable "listePays" et de stocker la valeur choisie dans "paysChoisi" :</p>
<p><a href="http://sebprunier.files.wordpress.com/2011/06/bonita-pageflow.png"><img class="aligncenter size-medium wp-image-48" title="bonita-pageflow" src="assets/bonita-pageflow.png?w=300" alt="" width="300" height="207" /></a></p>
<p>Cette variable peut être réutilisée par la suite, par exemple dans le pageflow lié à l'activité "Afficher le pays choisi" :</p>
<p><a href="http://sebprunier.files.wordpress.com/2011/06/bonita-pageflow-2.png"><img class="aligncenter size-medium wp-image-49" title="bonita-pageflow-2" src="assets/bonita-pageflow-2.png?w=300" alt="" width="300" height="261" /></a></p>
<h2>Conclusion</h2>
<p>On voit ici toute la puissance de Bonita Open Solution, notamment avec son approche "Connecteurs", mais également la relative complexité de l'utilisation du Client Web Service avec sa configuration assez bas-niveau (écriture de la requête SOAP, traitement de la réponse).</p>
<p><a href="http://www.filedropper.com/processusdemocombows--10" target="_blank">Téléchargez la démo !</a></p>
<p><em>Premier tuto sur mon blog ! Issu d'une problématique rencontrée sur un projet concret. Merci à Sébastien DAVID (<a href="http://www.ovialis.fr" target="_blank">Ovialis</a>) pour sa participation au projet, en particulier pour la configuration du connecteur.</em></p>
